<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡¶Æ‡ßÅ‡¶∞‡¶ó‡¶ø‡¶∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‚Äî Poultry Ledger (Receipt enabled)</title>
  <style>
    :root { font-family: "Noto Sans", Arial, sans-serif; }
    body { margin:12px; background:#f7f8fb; color:#111; }
    header { display:flex; align-items:center; gap:12px; }
    h1 { margin:0; font-size:20px; }
    .card { background:white; border-radius:8px; padding:12px; box-shadow:0 1px 6px rgba(10,10,20,0.06); margin-top:12px; }
    label { display:block; font-size:13px; margin-top:8px; }
    input[type="number"], input[type="text"], select { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; border:1px solid #ddd; border-radius:6px; font-size:14px; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    button { padding:10px 12px; border:0; background:#0b79d0; color:white; border-radius:6px; font-weight:600; cursor:pointer; }
    button.secondary { background:#666; }
    .summary { display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
    .stat { flex:1; min-width:140px; background:#f2f6fb; padding:10px; border-radius:8px; font-size:14px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
    th, td { padding:8px; text-align:left; border-bottom:1px solid #eee; }
    .muted { color:#666; font-size:13px; }
    .actions button { margin-right:6px; padding:6px 8px; font-size:13px; }
    .danger { background:#d9534f; color:white; border:none; border-radius:6px; padding:8px 10px; cursor:pointer; }
    .small { font-size:13px; padding:6px 8px; border-radius:6px; }
    input[type="checkbox"] { transform:scale(1.05); }
    @media (min-width:700px){ .row-2 { display:flex; gap:12px; } .row-2 > * { flex:1; } }

    /* Printable area hidden normally */
    #printArea { display:none; }

    /* Print styles: show only printArea */
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; display:block; padding:20px; }
      table { width:100%; border-collapse:collapse; }
      table, th, td { border: 1px solid #222; }
      th, td { padding:6px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>üêî ‡¶¨‡ßç‡¶∞‡¶Ø‡¶º‡¶≤‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡¶ï‡¶æ‡¶∞‡ßÄ ‚Äî ‡¶∞‡¶∂‡¶ø‡¶¶/‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá</h1>
  </header>

  <section class="card" id="entryCard">
    <div style="display:flex; gap:12px; align-items:center; justify-content:space-between;">
      <strong>‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßã</strong>
      <div class="muted">‡¶™‡¶≤‡ßç‡¶≤‡¶æ ‡¶è‡¶ï‡¶ï ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü = <span id="pallaSizeLabel">10</span> ‡¶™‡¶ø‡¶∏</div>
    </div>

    <div class="row-2" style="margin-top:8px;">
      <div>
        <label>‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ (Add = ‡¶≠‡¶æ‡¶£‡ßç‡¶°‡¶æ‡¶∞‡ßá ‡¶Ø‡ßã‡¶ó / Sale = ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø)</label>
        <select id="type">
          <option value="in">Add (‡¶Ø‡ßã‡¶ó)</option>
          <option value="out">Sale (‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø)</option>
        </select>

        <label>‡¶ì‡¶ú‡¶® (‡¶ï‡ßá‡¶ú‡¶ø) ‚Äî ‡¶ê ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶ì‡¶ú‡¶®</label>
        <input id="weight" type="number" min="0" step="0.01" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: 12.50" />

        <label>‡¶™‡¶ø‡¶∏ (‡¶™‡¶ø‡¶∏ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ) ‚Äî ‡¶Ø‡¶¶‡¶ø ‡¶®‡¶æ ‡¶ú‡¶æ‡¶®‡ßã, ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶∞‡¶æ‡¶ñ‡ßã</label>
        <input id="pieces" type="number" min="0" step="1" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: 12" />
      </div>

      <div>
        <label>‡¶ó‡ßú ‡¶ì‡¶ú‡¶® (‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶™‡¶ø‡¶∏ ‡¶ó‡ßú, ‡¶ï‡ßá‡¶ú‡¶ø) ‚Äî ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶™‡¶ø‡¶∏ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶π‡¶¨‡ßá</label>
        <input id="avgWeight" type="number" min="0" step="0.01" placeholder="‡¶Ø‡¶¶‡¶ø ‡¶ú‡¶æ‡¶®‡ßã, ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶¶‡¶æ‡¶ì" />

        <label>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ / ‡¶®‡ßã‡¶ü</label>
        <input id="note" type="text" placeholder="‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ ‡¶®‡¶æ‡¶Æ, ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞/‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" style="padding:8px" />

        <div style="display:flex; gap:8px; margin-top:12px;">
          <button id="addBtn">‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£</button>
          <button id="clearForm" class="secondary">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        </div>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>‡¶™‡¶≤‡ßç‡¶≤‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶™ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® (‡¶™‡¶õ‡¶®‡ßç‡¶¶‡¶Æ‡¶§)</label>
      <div style="display:flex; gap:8px;">
        <input id="pallaSize" type="number" min="1" step="1" value="10" style="width:120px" />
        <button id="setPalla" class="small secondary">‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßã</button>
        <div style="flex:1" class="muted">‡¶™‡¶≤‡ßç‡¶≤‡¶æ = (‡¶™‡¶ø‡¶∏ / ‡¶™‡¶≤‡ßç‡¶≤‡¶æ ‡¶Æ‡¶æ‡¶™)‡•§</div>
      </div>
    </div>
  </section>

  <section class="card">
    <strong>‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂</strong>
    <div class="summary">
      <div class="stat">
        <div class="muted">‡¶Æ‡ßã‡¶ü ‡¶™‡¶ø‡¶∏</div>
        <div id="totalPieces" style="font-size:18px; font-weight:700">0</div>
      </div>

      <div class="stat">
        <div class="muted">‡¶Æ‡ßã‡¶ü ‡¶™‡¶≤‡ßç‡¶≤‡¶æ (‡¶™‡ßÇ‡¶∞‡ßç‡¶£ + ‡¶≠‡¶ó‡ßç‡¶®‡¶æ‡¶Ç‡¶∂)</div>
        <div id="totalPalla" style="font-size:18px; font-weight:700">0.0</div>
        <div class="muted" style="margin-top:6px" id="pallaBreak">0 ‡¶™‡¶≤‡ßç‡¶≤‡¶æ ‡¶ì 0 ‡¶™‡¶ø‡¶∏ ‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü</div>
      </div>

      <div class="stat">
        <div class="muted">‡¶Æ‡ßã‡¶ü ‡¶ì‡¶ú‡¶® (‡¶ï‡ßá‡¶ú‡¶ø)</div>
        <div id="totalWeight" style="font-size:18px; font-weight:700">0.00</div>
      </div>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px;">
      <button id="exportCsv" class="small">Export CSV</button>
      <button id="printSummary" class="small">Print Summary (PDF)</button>
      <button id="printSelected" class="small">Print Selected Receipt</button>
      <button id="resetAll" class="small danger">‡¶∏‡¶¨ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßã</button>
    </div>
  </section>

  <section class="card">
    <strong>‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡ßá‡¶° ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡ßÅ‡¶≤‡ßã (‡¶®‡¶ø‡¶ö‡ßá ‡¶Ø‡ßá ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá, ‡¶∏‡ßá‡¶ó‡ßÅ‡¶≤‡ßã‡¶á ‡¶∞‡¶∂‡¶ø‡¶¶‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá)</strong>
    <div class="muted" style="margin-top:6px">‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ö‡ßá‡¶ï‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ü‡¶ø‡¶ï ‡¶¶‡¶ø‡ßü‡ßá Print Selected ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßã‡•§</div>

    <table id="entriesTable" aria-live="polite">
      <thead>
        <tr>
          <th><input id="selectAll" type="checkbox" title="Select all" /></th>
          <th>‡¶∏‡¶Æ‡ßü</th>
          <th>‡¶ü‡¶æ‡¶á‡¶™</th>
          <th>‡¶ì‡¶ú‡¶® (‡¶ï‡ßá‡¶ú‡¶ø)</th>
          <th>‡¶™‡¶ø‡¶∏</th>
          <th>‡¶™‡¶≤‡ßç‡¶≤‡¶æ (‡¶°‡¶ø‡¶∏‡¶ø‡¶Æ‡¶æ‡¶≤)</th>
          <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
          <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Hidden printable area -->
  <div id="printArea" role="region" aria-label="Printable receipt area"></div>

  <script>
    // localStorage key
    const STORAGE_KEY = "poultry_ledger_v1";
    const DEFAULT_PALLA = 10;

    let state = { pallaSize: DEFAULT_PALLA, entries: [] };

    // DOM refs
    const weightEl = document.getElementById("weight");
    const piecesEl = document.getElementById("pieces");
    const avgWeightEl = document.getElementById("avgWeight");
    const noteEl = document.getElementById("note");
    const typeEl = document.getElementById("type");
    const addBtn = document.getElementById("addBtn");
    const clearForm = document.getElementById("clearForm");
    const entriesTableBody = document.querySelector("#entriesTable tbody");
    const totalPiecesEl = document.getElementById("totalPieces");
    const totalPallaEl = document.getElementById("totalPalla");
    const totalWeightEl = document.getElementById("totalWeight");
    const pallaSizeInput = document.getElementById("pallaSize");
    const setPallaBtn = document.getElementById("setPalla");
    const pallaSizeLabel = document.getElementById("pallaSizeLabel");
    const pallaBreak = document.getElementById("pallaBreak");
    const exportCsvBtn = document.getElementById("exportCsv");
    const resetAllBtn = document.getElementById("resetAll");
    const printArea = document.getElementById("printArea");
    const printSelectedBtn = document.getElementById("printSelected");
    const printSummaryBtn = document.getElementById("printSummary");
    const selectAllCheckbox = document.getElementById("selectAll");

    // load/save
    function load() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try { Object.assign(state, JSON.parse(raw)); } catch(e){ console.warn(e); }
      }
      if (!state.pallaSize || state.pallaSize < 1) state.pallaSize = DEFAULT_PALLA;
      pallaSizeInput.value = state.pallaSize;
      pallaSizeLabel.textContent = state.pallaSize;
      render();
    }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // utilities
    function parseNumber(v){ const x = parseFloat(v); return isNaN(x) ? 0 : x; }
    function computeTotals(){
      let totalPieces = 0, totalWeight = 0;
      for (const e of state.entries){
        const p = parseInt(e.pieces) || 0;
        const w = parseFloat(e.weight) || 0;
        if (e.type === "in") { totalPieces += p; totalWeight += w; }
        else { totalPieces -= p; totalWeight -= w; }
      }
      const pallaDecimal = totalPieces / state.pallaSize;
      const pallaFloor = Math.trunc(totalPieces / state.pallaSize);
      const remainder = ((totalPieces % state.pallaSize) + state.pallaSize) % state.pallaSize;
      return { totalPieces, totalWeight: Math.round(totalWeight*100)/100, pallaDecimal: Math.round(pallaDecimal*100)/100, pallaFloor, remainder };
    }
    function formatTime(iso){ const d=new Date(iso); return d.toLocaleString(); }

    // add/edit/delete
    function addEntry(entry){
      entry.id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
      entry.ts = new Date().toISOString();
      state.entries.unshift(entry);
      save(); render();
    }
    function deleteEntry(id){ state.entries = state.entries.filter(e => e.id !== id); save(); render(); }
    function editEntry(id, updates){
      const i = state.entries.findIndex(e => e.id === id);
      if (i>=0){ state.entries[i] = Object.assign({}, state.entries[i], updates); save(); render(); }
    }

    // render table + totals
    function render(){
      entriesTableBody.innerHTML = "";
      for (const e of state.entries){
        const tr = document.createElement("tr");
        const palla = ((parseInt(e.pieces)||0) / state.pallaSize);
        tr.innerHTML = `
          <td><input class="row-select" data-id="${e.id}" type="checkbox" /></td>
          <td>${formatTime(e.ts)}</td>
          <td>${e.type === 'in' ? 'Add' : 'Sale'}</td>
          <td>${(parseFloat(e.weight)||0).toFixed(2)}</td>
          <td>${parseInt(e.pieces)||0}</td>
          <td>${palla.toFixed(2)}</td>
          <td>${e.note || ''}</td>
          <td class="actions">
            <button class="small" data-id="${e.id}" data-action="edit">Edit</button>
            <button class="small" data-id="${e.id}" data-action="delete">Delete</button>
          </td>
        `;
        entriesTableBody.appendChild(tr);
      }
      const t = computeTotals();
      totalPiecesEl.textContent = t.totalPieces;
      totalPallaEl.textContent = t.pallaDecimal.toFixed(2);
      totalWeightEl.textContent = t.totalWeight.toFixed(2);
      pallaBreak.textContent = `${t.pallaFloor} ‡¶™‡¶≤‡ßç‡¶≤‡¶æ ‡¶è‡¶¨‡¶Ç ${t.remainder} ‡¶™‡¶ø‡¶∏ ‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü`;
      pallaSizeLabel.textContent = state.pallaSize;
    }

    // events: add
    addBtn.addEventListener("click", ()=>{
      const weight = parseNumber(weightEl.value);
      let pieces = parseInt(piecesEl.value);
      const avg = parseNumber(avgWeightEl.value);
      const type = typeEl.value;
      const note = noteEl.value.trim();
      if ((!weight || weight<=0) && (!pieces || pieces<=0)){ alert("‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶ì‡¶ú‡¶® ‡¶¨‡¶æ ‡¶™‡¶ø‡¶∏‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶æ‡ßü ‡¶Æ‡¶æ‡¶® ‡¶≤‡¶ø‡¶ñ‡ßã‡•§"); return; }
      if ((!pieces || pieces<=0) && avg > 0){ pieces = Math.round((weight/avg)||0); }
      if (!pieces || pieces < 0) pieces = 0;
      addEntry({ type, weight: Math.round(weight*100)/100, pieces, note });
      weightEl.value=""; piecesEl.value=""; avgWeightEl.value=""; noteEl.value="";
    });

    clearForm.addEventListener("click", ()=>{ weightEl.value=""; piecesEl.value=""; avgWeightEl.value=""; noteEl.value=""; typeEl.value="in"; });

    entriesTableBody.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("button");
      if (!btn) return;
      const id = btn.dataset.id; const action = btn.dataset.action;
      if (action === "delete"){ if (confirm("‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡¶õ‡ßã?")) deleteEntry(id); }
      else if (action === "edit"){
        const entry = state.entries.find(e => e.id === id); if (!entry) return;
        typeEl.value = entry.type; weightEl.value = entry.weight; piecesEl.value = entry.pieces; noteEl.value = entry.note;
        deleteEntry(id);
        window.scrollTo({top:0, behavior:"smooth"});
      }
    });

    setPallaBtn.addEventListener("click", ()=>{
      const v = parseInt(pallaSizeInput.value) || DEFAULT_PALLA;
      if (v < 1){ alert("‡¶™‡¶≤‡ßç‡¶≤‡¶æ ‡¶è‡¶ï‡¶ï ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá 1 ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá"); return; }
      state.pallaSize = v; save(); render();
    });

    exportCsvBtn.addEventListener("click", ()=>{
      const header = ["timestamp,type,weight,pieces,palla,note"];
      const lines = state.entries.map(e => {
        const palla = ((parseInt(e.pieces)||0)/state.pallaSize).toFixed(2);
        return [e.ts, e.type, (parseFloat(e.weight)||0).toFixed(2), (parseInt(e.pieces)||0), palla, `"${(e.note||"").replace(/"/g,'""')}"`].join(",");
      });
      const csv = header.concat(lines).join("\n");
      const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "poultry_ledger.csv"; a.click(); URL.revokeObjectURL(url);
    });

    resetAllBtn.addEventListener("click", ()=>{
      if (confirm("‡¶™‡ßÅ‡¶∞‡ßã ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶ì? ‡¶è‡¶á ‡¶ï‡¶æ‡¶ú ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶®‡ßü‡•§")){
        state.entries = []; save(); render();
      }
    });

    // select all
    selectAllCheckbox.addEventListener("change", ()=>{
      const checked = selectAllCheckbox.checked;
      document.querySelectorAll(".row-select").forEach(cb => cb.checked = checked);
    });

    // Print: build printable HTML in printArea and call window.print()
    function buildReceiptHtml(selectedEntries, meta){
      // meta: {title, subtitle, showTotals}
      const farmName = meta.farmName || "‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ñ‡¶æ‡¶Æ‡¶æ";
      const now = new Date();
      const headerHtml = `
        <div style="text-align:center;margin-bottom:8px;">
          <div style="font-size:20px;font-weight:700;">${farmName}</div>
          <div style="font-size:14px;">${meta.subtitle || '‡¶™‡¶æ‡¶≤‡ßç‡¶≤‡¶æ/‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶∞‡¶∂‡¶ø‡¶¶'}</div>
          <div style="margin-top:6px;font-size:12px;">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶∏‡¶Æ‡ßü: ${now.toLocaleString()}</div>
        </div>
      `;

      const rows = selectedEntries.map((e, idx) => {
        const p = parseInt(e.pieces) || 0;
        const w = (parseFloat(e.weight)||0).toFixed(2);
        const palla = (p / state.pallaSize).toFixed(2);
        return `<tr>
          <td style="width:5%;text-align:center;">${idx+1}</td>
          <td style="width:25%;">${formatTime(e.ts)}</td>
          <td style="width:12%;">${e.type === 'in' ? 'Add' : 'Sale'}</td>
          <td style="width:12%;text-align:right;">${w}</td>
          <td style="width:12%;text-align:right;">${p}</td>
          <td style="width:12%;text-align:right;">${palla}</td>
          <td style="width:20%;">${(e.note||'')}</td>
        </tr>`;
      }).join("");

      let totalsHtml = "";
      if (meta.showTotals){
        // compute totals over selectedEntries (in/out directionally)
        let tPieces = 0, tWeight = 0;
        for (const e of selectedEntries){
          const p = parseInt(e.pieces) || 0;
          const w = parseFloat(e.weight) || 0;
          if (e.type === "in"){ tPieces += p; tWeight += w; } else { tPieces -= p; tWeight -= w; }
        }
        const pallaDecimal = (tPieces / state.pallaSize);
        const pallaFloor = Math.trunc(tPieces / state.pallaSize);
        const remainder = ((tPieces % state.pallaSize) + state.pallaSize) % state.pallaSize;
        totalsHtml = `
          <div style="margin-top:12px;">
            <strong>‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ (‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°):</strong>
            <div>‡¶Æ‡ßã‡¶ü ‡¶™‡¶ø‡¶∏: ${tPieces}</div>
            <div>‡¶Æ‡ßã‡¶ü ‡¶™‡¶≤‡ßç‡¶≤‡¶æ: ${pallaDecimal.toFixed(2)} (${pallaFloor} ‡¶™‡¶≤‡ßç‡¶≤‡¶æ ‡¶è‡¶¨‡¶Ç ${remainder} ‡¶™‡¶ø‡¶∏)</div>
            <div>‡¶Æ‡ßã‡¶ü ‡¶ì‡¶ú‡¶®: ${tWeight.toFixed(2)} ‡¶ï‡ßá‡¶ú‡¶ø</div>
          </div>
        `;
      }

      const footerHtml = `
        <div style="margin-top:20px; display:flex; justify-content:space-between;">
          <div>‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ï‡¶æ‡¶∞‡¶ï: __________________</div>
          <div>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞: __________________</div>
        </div>
        <div style="margin-top:6px;font-size:11px;color:#333;">(‡¶∞‡¶∂‡¶ø‡¶¶‡¶ü‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®)</div>
      `;

      return `
        <div>
          ${headerHtml}
          <table style="width:100%; margin-top:6px; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="border:1px solid #222;padding:6px;">#</th>
                <th style="border:1px solid #222;padding:6px;">‡¶∏‡¶Æ‡ßü</th>
                <th style="border:1px solid #222;padding:6px;">‡¶ü‡¶æ‡¶á‡¶™</th>
                <th style="border:1px solid #222;padding:6px;text-align:right;">‡¶ì‡¶ú‡¶®(‡¶ï‡ßá‡¶ú‡¶ø)</th>
                <th style="border:1px solid #222;padding:6px;text-align:right;">‡¶™‡¶ø‡¶∏</th>
                <th style="border:1px solid #222;padding:6px;text-align:right;">‡¶™‡¶≤‡ßç‡¶≤‡¶æ</th>
                <th style="border:1px solid #222;padding:6px;">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
          ${totalsHtml}
          ${footerHtml}
        </div>
      `;
    }

    // function to get selected entries
    function getSelectedEntries(){
      const ids = Array.from(document.querySelectorAll(".row-select"))
        .filter(cb => cb.checked)
        .map(cb => cb.dataset.id);
      return state.entries.filter(e => ids.includes(e.id));
    }

    // Print selected entries as receipt
    printSelectedBtn.addEventListener("click", ()=>{
      const selected = getSelectedEntries();
      if (!selected || selected.length === 0){ alert("‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßã‡•§"); return; }
      // build print HTML
      const html = buildReceiptHtml(selected, { title: "Receipt", subtitle: "‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶∞ ‡¶∞‡¶∂‡¶ø‡¶¶", showTotals: true, farmName: "‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ñ‡¶æ‡¶Æ‡¶æ" });
      printArea.innerHTML = html;
      // open print dialog
      window.print();
      // small delay to clear printable area (optional)
      setTimeout(()=>{ printArea.innerHTML = ""; }, 500);
    });

    // Print overall summary (all entries) ‚Äî useful for end-of-day
    printSummaryBtn.addEventListener("click", ()=>{
      const allEntries = state.entries.slice(); // copy
      if (!allEntries || allEntries.length === 0){ if (!confirm("‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßã ‡¶®‡¶ø ‚Äî ‡¶§‡¶æ‡¶∞‡¶™‡¶∞‡¶ì ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶ì?")) return; }
      const html = buildReceiptHtml(allEntries, { title: "Summary", subtitle: "‡¶Æ‡ßã‡¶ü ‡¶∞‡¶∂‡¶ø‡¶¶ / ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂", showTotals: true, farmName: "‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ñ‡¶æ‡¶Æ‡¶æ" });
      printArea.innerHTML = html;
      window.print();
      setTimeout(()=>{ printArea.innerHTML = ""; }, 500);
    });

    // auto-calc pieces when avg provided
    avgWeightEl.addEventListener("blur", ()=>{
      const p = parseInt(piecesEl.value) || 0;
      const avg = parseNumber(avgWeightEl.value);
      const weight = parseNumber(weightEl.value);
      if ((!p || p <= 0) && avg > 0 && weight > 0) { piecesEl.value = Math.round(weight / avg); }
    });

    // init
    load();
    console.log("Poultry Ledger with receipt loaded. localStorage key:", STORAGE_KEY);
  </script>
</body>
</html>